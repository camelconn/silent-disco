<!DOCTYPE html>
<html>
<head><meta charset="UTFâ€‘8"><title>HLS PDT Demo Sync</title></head>
<body>
  <button id="go">Start Synced Stream</button>
  <video id="vid" width="600" controls></video>
  <pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const url = 'https://mtoczko.github.io/hls-test-streams/test-program-time/playlist.m3u8';
const vid = document.getElementById('vid');
const log = txt => document.getElementById('log').textContent += txt + '\n';

async function syncClock() {
  let offsets = [];
  for (let i=0; i<5; i++){
    const t0 = performance.now();
    const res = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
    const t1 = performance.now();
    const data = await res.json();
    offsets.push(new Date(data.utc_datetime).getTime() - (Date.now() + (t1 - t0)/2));
    await new Promise(r => setTimeout(r,150));
  }
  return offsets.reduce((a,b)=>a+b)/offsets.length;
}

async function start(){
  log('Syncing clock...');
  const offset = await syncClock();
  log(`Clock offset: ${offset.toFixed(2)} ms`);

  log('Fetching playlist...');
  const pls = await fetch(url).then(r=>r.text());
  const lines = pls.split('\n');
  const pdtLine = lines.reverse().find(l=>l.startsWith('#EXT-X-PROGRAM-DATE-TIME'));
  const ts = new Date(pdtLine.split(':')[1]).getTime();
  log(`Latest segment time: ${new Date(ts).toISOString()}`);

  const now = Date.now() + offset;
  const delay = (now - ts) / 1000;
  log(`Calculated delay: ${delay.toFixed(2)} sec`);

  vid.style.display = 'block';
  if (Hls.isSupported()) {
    const h = new Hls();
    h.loadSource(url);
    h.attachMedia(vid);
    h.on(Hls.Events.MANIFEST_PARSED, ()=>{
      vid.currentTime = vid.duration - delay; 
      vid.play();
      log('Started_PLAY at ' + vid.currentTime.toFixed(2));
    });
  }
}

document.getElementById('go').onclick = start;
</script>
</body>
</html>
